<div class="page">
    <p-toast position="top-right"></p-toast>

    <header class="topbar">
        <div class="topbar-left">
            <img src="assets/logo.jpeg" alt="PulseQ" class="logo" />
            <div class="brand">PulseQ</div>
        </div>

        <nav class="topnav">
            <a routerLink="/patient/dashboard">Dashboard</a>
            <a routerLink="/patient/new-token" class="active">New Token</a>
            <a routerLink="/patient/live-status">Live Status</a>
            <a routerLink="/patient/my-token">My Token</a>
            <a routerLink="/patient/history">History</a>
        </nav>

        <div class="topbar-right">
            <a pButton type="button" icon="pi pi-bell" class="p-button-text" routerLink="/patient/notifications"
                aria-label="Notifications"></a>
            <a routerLink="/patient/profile" class="avatar" title="Profile"><i class="pi pi-user"
                    aria-hidden="true"></i></a>
        </div>
    </header>

    <main class="container">
        <div class="intro">
            <div>
                <h1>Create New Token</h1>
                <p class="subtitle">Fill in the details to request a token for your appointment.</p>
            </div>
        </div>

        <div class="form-wrapper">

            <div class="alert alert-primary mb-4">
                <div class="alert-wrapper">
                    <i class="pi pi-info-circle alert-icon"></i>
                    <div class="alert-content">
                        <strong class="alert-title">Important Notice</strong>
                        <p class="alert-message">
                            Tokens are valid only for today. Please arrive at least 15 minutes early.
                        </p>
                    </div>
                </div>
            </div>

            <p-card class="form-card">
                <div class="steps-bar">
                    <div class="dots">
                        <span [class.active]="step === 1"></span>
                        <span [class.active]="step === 2"></span>
                    </div>
                </div>

                <form [formGroup]="tokenForm" (ngSubmit)="submitForm()">

                    <div *ngIf="step === 1">
                        <!-- HOSPITAL -->
                        <div class="form-group">
                            <label class="form-label">Hospital <span class="required">*</span></label>

                            <p-dropdown [options]="hospitals" optionLabel="name" formControlName="hospital"
                                placeholder="Select a hospital" class="w-full">
                            </p-dropdown>

                            <div class="error-message"
                                *ngIf="f['hospital'].invalid && (f['hospital'].dirty || f['hospital'].touched)">
                                Hospital is required
                            </div>
                        </div>

                        <!-- DEPARTMENT -->
                        <div class="form-group">
                            <label class="form-label">Department <span class="required">*</span></label>

                            <p-dropdown [options]="departments" optionLabel="label" formControlName="department"
                                placeholder="Select a department" class="w-full">
                            </p-dropdown>

                            <div class="error-message"
                                *ngIf="f['department'].invalid && (f['department'].dirty || f['department'].touched)">
                                Department is required
                            </div>
                        </div>

                        <!-- DOCTOR -->
                        <div class="form-group">
                            <label class="form-label">
                                Doctor <span class="optional">(Optional)</span>
                            </label>

                            <p-dropdown [options]="filteredDoctors" optionLabel="name" formControlName="doctor"
                                placeholder="Select a doctor" class="w-full">
                            </p-dropdown>

                            <!-- ASSIGN ANY AVAILABLE DOCTOR  -->
                            <div class="checkbox-group" style="margin-top: 12px;">
                                <input type="checkbox" id="assignAnyDoctor" [checked]="assignAnyDoctor"
                                    (change)="toggleAssignAnyDoctor()" class="form-checkbox" />
                                <label for="assignAnyDoctor" class="checkbox-label">
                                    Assign any available doctor
                                </label>
                            </div>

                            <div class="hint-text" *ngIf="!f['department'].value">
                                Select a department first
                            </div>
                        </div>
                    </div>

                    <!-- PATIENT DETAILS (shown after hospital + department is selected) -->
                    <div class="form-section" *ngIf="step === 2">
                        <h3 class="section-title">Patient Details</h3>

                        <div class="two-col">
                            <div class="form-group">
                                <label class="form-label">Full Name <span class="required">*</span></label>
                                <input pInputText type="text" formControlName="patientName" placeholder="name"
                                    class="w-full" />
                                <div class="error-message"
                                    *ngIf="f['patientName'].invalid && (f['patientName'].dirty || f['patientName'].touched)">
                                    Name is required
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Phone Number <span class="required">*</span></label>
                                <input pInputText type="text" formControlName="phone"
                                    placeholder="e.g. 03001234567 or +923001234567" class="w-full" />
                                <div class="error-message"
                                    *ngIf="f['phone'].invalid && (f['phone'].dirty || f['phone'].touched)">
                                    <span *ngIf="f['phone'].errors?.['required']">Phone number is required</span>
                                    <span *ngIf="f['phone'].errors?.['invalidPakistaniPhone']">Please enter a valid
                                        Pakistani phone number (e.g., 03XX-XXXXXXX or +923XX-XXXXXXX)</span>
                                </div>
                            </div>
                        </div>

                        <div class="two-col">
                            <div class="form-group">
                                <label class="form-label">Age</label>
                                <input pInputText type="number" formControlName="age" placeholder="Years"
                                    class="w-full" />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Gender</label>
                                <p-dropdown
                                    [options]="[{label:'Male', value:'Male'},{label:'Female',value:'Female'},{label:'Other',value:'Other'}]"
                                    formControlName="gender" class="w-full"></p-dropdown>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Special Notes</label>
                            <textarea pInputTextarea formControlName="specialNotes" rows="3"
                                placeholder="Any allergies or special notes" class="w-full"></textarea>
                        </div>

                        <!-- REASON -->
                        <div class="form-group">
                            <label class="form-label">Reason <span class="required">*</span></label>

                            <textarea pInputTextarea formControlName="reason" rows="4"
                                placeholder="Describe your reason..." class="w-full"></textarea>

                            <div class="error-message"
                                *ngIf="f['reason'].invalid && (f['reason'].dirty || f['reason'].touched)">
                                <span *ngIf="f['reason'].errors?.['required']">Reason is required</span>
                                <span *ngIf="f['reason'].errors?.['minlength']">
                                    Minimum 5 characters required
                                </span>
                            </div>
                        </div>

                    </div>

                    <!-- ACTIONS -->
                    <div class="form-actions">
                        <ng-container *ngIf="step === 1">
                            <button pButton label="Next" icon="pi pi-arrow-right" type="button" class="submit-btn"
                                (click)="nextStep()"
                                [disabled]="!f['hospital'].value || !f['department'].value || (filteredDoctors.length > 0 && !f['doctor'].value)">
                            </button>

                            <button pButton label="Cancel" icon="pi pi-times" type="button"
                                class="p-button-outlined cancel-btn" (click)="cancelForm()">
                            </button>
                        </ng-container>

                        <ng-container *ngIf="step === 2">
                            <button pButton label="Back" icon="pi pi-arrow-left" type="button" class="p-button-outlined"
                                (click)="previousStep()">
                            </button>

                            <button pButton label="Generate Token" icon="pi pi-check" type="submit" class="submit-btn"
                                [disabled]="tokenForm.invalid">
                            </button>
                        </ng-container>
                    </div>

                </form>
            </p-card>
        </div>
    </main>
</div>