<p-toast position="top-right"></p-toast>

<div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="brand">
            <i class="pi pi-clipboard brand-icon"></i>
            <span>Reception</span>
        </div>

        <nav class="nav">
            <ul>
                <li [class.active]="currentNav === 'dashboard'" (click)="navigateTo('dashboard')">
                    <i class="pi pi-th-large"></i>
                    <span>Dashboard</span>
                </li>
                <li [class.active]="currentNav === 'queue'">
                    <i class="pi pi-clipboard"></i>
                    <span>Queue List</span>
                </li>
            </ul>
        </nav>

        <div class="signout" (click)="signOut()">
            <i class="pi pi-sign-out"></i> Sign Out
        </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
        <div class="header-row">
            <div>
                <h2>Queue List</h2>
                <p class="subtitle">View and manage all tokens.</p>
            </div>
        </div>

        <!-- SEARCH & FILTER -->
        <div class="search-bar">
            <i class="pi pi-search"></i>
            <input type="text" placeholder="Search by name or token..." [(ngModel)]="searchText"
                (ngModelChange)="onSearchChange($event)" />
            <i class="pi pi-filter"></i>
            <p-dropdown [options]="statuses" [(ngModel)]="selectedStatus" (onChange)="onStatusChange()">
            </p-dropdown>
            <p-dropdown [options]="paymentOptions" [(ngModel)]="paymentFilter" (onChange)="onPaymentChange()">
            </p-dropdown>
        </div>

        <!-- TABLE -->
        <p-card class="table-card">
            <p-table [value]="filteredTokens" [paginator]="true" [rows]="10">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Token</th>
                        <th>Patient Details</th>
                        <th>Department</th>
                        <th>Payment</th>
                        <th>Status</th>
                        <th>Reason</th>
                        <th>Actions</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-row>
                    <tr>
                        <td><strong>{{row.token}}</strong></td>
                        <td>
                            <div class="name">{{row.name}}</div>
                            <div class="small">{{row.age}}y â€¢ {{row.gender}}</div>
                        </td>
                        <td>{{row.department}}</td>
                        <td>
                            <span [ngClass]="{
                                'payment-badge': true,
                                'payment-paid': (row.paymentStatus || 'unpaid') === 'paid',
                                'payment-unpaid': (row.paymentStatus || 'unpaid') !== 'paid'
                            }">{{ (row.paymentStatus || 'unpaid') | titlecase }}</span>
                        </td>
                        <td>
                            <span [ngClass]="{
                                'status-badge': true,
                                'status-pending': row.status === 'pending',
                                'status-completed': row.status === 'completed',
                                'status-skipped': row.status === 'skipped'
                            }">
                                {{row.status || 'pending' | titlecase}}
                            </span>
                        </td>
                        <td>{{row.reason}}</td>
                        <td>
                            <button pButton icon="pi pi-eye" severity="info" class="p-button-text p-button-plain"
                                pTooltip="View" (click)="view(row)"></button>
                            <button pButton icon="pi pi-pencil" severity="success" class="p-button-text p-button-plain"
                                pTooltip="Edit" (click)="edit(row)"></button>
                            <button pButton icon="pi pi-trash" severity="danger" class="p-button-text p-button-plain"
                                pTooltip="Delete" (click)="delete(row)"></button>
                            <button pButton icon="pi pi-plus" label="re-add" severity="danger"
                                class="p-button-sm re-add-btn" pTooltip="Re-add to Queue" (click)="reAddToken(row)"
                                *ngIf="row.status === 'skipped'"></button>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: #9ca3af; font-size: 0.95rem;">
                            NO ITEMS FOUND
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </p-card>
    </main>
</div>

<!-- VIEW DIALOG (READ ONLY) -->
<p-dialog header="View Token" [(visible)]="viewVisible" [modal]="true" [style]="{width:'480px'}">
    <div *ngIf="viewModel" class="p-fluid queue-dialog">
        <div class="p-field">
            <label>Token</label>
            <input pInputText [value]="viewModel.token" disabled />
        </div>
        <div class="p-field">
            <label>Name</label>
            <input pInputText [value]="viewModel.name" disabled />
        </div>
        <div class="p-field">
            <label>Age</label>
            <input pInputText [value]="viewModel.age" disabled />
        </div>
        <div class="p-field">
            <label>Gender</label>
            <input pInputText [value]="viewModel.gender" disabled />
        </div>
        <div class="p-field">
            <label>Department</label>
            <input pInputText [value]="viewModel.department" disabled />
        </div>
        <div class="p-field">
            <label>Reason</label>
            <input pInputText [value]="viewModel.reason" disabled />
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button pButton label="Close" (click)="viewVisible=false" class="p-button-secondary"
                style="flex: 1;"></button>
        </div>
    </div>
</p-dialog>

<!-- EDIT DIALOG -->
<p-dialog header="Edit Token Details" [(visible)]="editVisible" [modal]="true" [style]="{width:'480px'}">
    <div *ngIf="editModel" class="p-fluid queue-dialog">
        <div class="p-field">
            <label>Token</label>
            <input pInputText [value]="editModel.token" disabled />
        </div>
        <div class="p-field">
            <label>Name</label>
            <input pInputText [(ngModel)]="editModel.name" placeholder="Patient name" />
        </div>
        <div class="p-field">
            <label>Age</label>
            <input type="number" pInputText [(ngModel)]="editModel.age" placeholder="Age" />
        </div>
        <div class="p-field">
            <label>Gender</label>
            <p-dropdown [(ngModel)]="editModel.gender" [options]="genderOptions"
                placeholder="Select gender"></p-dropdown>
        </div>
        <div class="p-field">
            <label>Department</label>
            <p-dropdown [(ngModel)]="editModel.department" [options]="departments"
                placeholder="Select department"></p-dropdown>
        </div>
        <div class="p-field">
            <label>Payment</label>
            <p-dropdown [(ngModel)]="editModel!.paymentStatus" [options]="paymentOptionsNoAll"
                placeholder="Select payment"></p-dropdown>
        </div>
        <div class="p-field">
            <label>Phone</label>
            <input pInputText [(ngModel)]="editModel.phone" placeholder="Phone number" />
        </div>
        <div class="p-field">
            <label>Reason</label>
            <textarea pInputTextarea [(ngModel)]="editModel.reason" rows="3" placeholder="Reason for visit"></textarea>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button pButton label="Save" (click)="saveEdit()" class="p-button-success" style="flex: 1;"></button>
            <button pButton label="Cancel" (click)="editVisible=false" class="p-button-secondary"
                style="flex: 1;"></button>
        </div>
    </div>
</p-dialog>

<!-- DELETE CONFIRMATION DIALOG -->
<p-dialog header="Confirm Delete" [(visible)]="deleteConfirmVisible" [modal]="true" [style]="{width:'400px'}">
    <div *ngIf="deleteModel">
        <p>Are you sure you want to delete <strong>{{deleteModel.token}}</strong> ({{deleteModel.name}})?</p>
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button pButton label="Delete" (click)="confirmDelete()" class="p-button-danger" style="flex: 1;"></button>
            <button pButton label="Cancel" (click)="deleteConfirmVisible=false" class="p-button-secondary"
                style="flex: 1;"></button>
        </div>
    </div>
</p-dialog>